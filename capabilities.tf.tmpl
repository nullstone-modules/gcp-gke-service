{{ range . -}}
provider "ns" {
  capability_name = "{{ .Name }}"
  alias           = "{{ .TfModuleName }}"
}

module "{{ .TfModuleName }}" {
  source  = "{{ .Source }}/any"
  {{- if (ne .SourceVersion "latest") }}
  version = "{{ .SourceVersion }}"
  {{- end }}

  app_metadata = local.app_metadata
  {{ range $key, $value := .Variables -}}{{- if $value.HasValue }}
  {{ $key }} = jsondecode({{ $value.Value | to_json_string }})
  {{- end -}}{{- end }}

  providers = {
    ns = ns.{{ .TfModuleName }}
  }
}
{{ end }}

locals {
  cap_modules = [
{{- range $index, $element := .ExceptNeedsDestroyed }}
    {{ if $index }}, {{ end }}{
      name       = "{{ $element.Name }}"
      tfId       = "{{ $element.TfId }}"
      namespace  = "{{ $element.Namespace }}"
      env_prefix = "{{ $element.EnvPrefix }}"
      outputs    = {{ $element.TfModuleAddr }}

      meta = jsondecode({{ $element.Meta | to_json_string }})
    }
{{- end }}
  ]

  cap_env_prefixes = {
    for mod in local.cap_modules : mod.tfId => mod.env_prefix
  }

  capabilities = {
    for outputName in local.capability_output_names : outputName => flatten([
      for mod in local.cap_modules : [ for x in lookup(mod.outputs, outputName, []) : merge({ cap_tf_id = mod.tfId }, x) ] if contains(try(mod.meta.outputNames, []), outputName)
    ])
  }
}
